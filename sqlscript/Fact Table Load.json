{
	"name": "Fact Table Load",
	"properties": {
		"content": {
			"query": "DROP PROCEDURE \n\nCREATE PROCEDURE load_data_warehouse\nAS BEGIN\n\n--create rides fact table\n\nIF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'FactRides')\nDROP TABLE FactRides\n\nCREATE TABLE dbo.FactRides (\n    RideDate DATE NOT NULL,\n    StationID INT NOT NULL,\n    StationComplex NVARCHAR(100) NULL,\n    TransitMode NVARCHAR(100) NULL,\n    PaymentMethod NVARCHAR(100) NULL,\n    FareClassCategory NVARCHAR(100) NULL,\n    Transfers INT NULL,\n    DateUpdated DATETIME\n)\nWITH\n(\n    DISTRIBUTION = HASH(StationComplex),\n    CLUSTERED COLUMNSTORE INDEX\n)\n\n\n--create rides staging table\n\nIF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'StageRides')\nDROP TABLE StageRides\n\nCREATE TABLE dbo.StageRides (\n    RideDate DATE NOT NULL,\n    StationComplex NVARCHAR(100) NULL,\n    TransitMode NVARCHAR(100) NULL,\n    PaymentMethod NVARCHAR(100) NULL,\n    FareClassCategory NVARCHAR(100) NULL,\n    Transfers INT NULL\n)\nWITH\n(\n    DISTRIBUTION = ROUND_ROBIN,\n    CLUSTERED COLUMNSTORE INDEX\n)\n\n\n\n--load data into staging table\n\nCOPY INTO dbo.StageRides\n(RideDate, StationComplex, TransitMode, PaymentMethod, FareClassCategory, Transfers)\nFROM 'https://mtapipelinestorage.dfs.core.windows.net/files/updated_data/rider_data/*parquet'\nWITH\n(\n    FILE_TYPE = 'PARQUET',\n    MAXERRORS = 0,\n    IDENTITY_INSERT = 'OFF'\n)\n\n--load data into Fact table\n\nINSERT INTO dbo.FactRides\nSELECT\n    r.RideDate,\n    s.StationId,\n    r.StationComplex,\n    r.TransitMode,\n    r.PaymentMethod,\n    r.FareClassCategory,\n    r.Transfers,\n    DateUpated = CURRENT_TIMESTAMP\nFROM StageRides r \nJOIN\nDimStation s ON s.StationComplex = r.StationComplex\n\n\nEND\nGO\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "mtasqlpool",
				"poolName": "mtasqlpool"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}