{
	"name": "Load Data to Warehouse",
	"properties": {
		"content": {
			"query": "CREATE PROCEDURE load_data_warehouse\nAS BEGIN\n\n--create station dimension table\n\nIF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'DimStation')\nDROP TABLE DimStation\n\nCREATE TABLE dbo.DimStation\n(   StationId INT,\n    DateUpdated DATETIME,\n    StationName NVARCHAR(50) NOT NULL,\n    StationComplex NVARCHAR(50) NULL,\n    Borough NVARCHAR(15) NULL,\n    IsHistorical BIT NULL,\n    ServiceAvailable BIT NULL,\n    WifiAvailable BIT NULL\n)\nWITH (\n    DISTRIBUTION = REPLICATE,\n    CLUSTERED COLUMNSTORE INDEX\n)\n\n--create station staging table\n\nIF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'StageStation')\nDROP TABLE StageStation\n\nCREATE TABLE dbo.StageStation (\n    StationName NVARCHAR(50) NULL,\n    StationComplex NVARCHAR(50) NULL,\n    Borough NVARCHAR(15) NULL,\n    IsHistorical BIT NULL,\n    ServiceAvailable BIT NULL,\n    WifiAvailable BIT NULL\n)\nWITH\n(\n    DISTRIBUTION = ROUND_ROBIN,\n    CLUSTERED COLUMNSTORE INDEX\n);\n\n\n--load data to stage table\nDELETE FROM dbo.StageStation\n\nCOPY INTO dbo.StageStation\n(StationName, StationComplex, Borough, IsHistorical, ServiceAvailable, WifiAvailable)\nFROM 'https://mtapipelinestorage.dfs.core.windows.net/files/updated_data/station_data/*parquet'\nWITH\n(\n    FILE_TYPE = 'PARQUET',\n    MAXERRORS = 0,\n    IDENTITY_INSERT = 'OFF'\n);\n\n\n--insert data into dimension table\n\nDELETE FROM dbo.DimStation\n\nINSERT INTO dbo.DimStation\nSELECT \n    ROW_NUMBER() OVER(ORDER BY (SELECT 0)) AS StationId,\n    CURRENT_TIMESTAMP,\n    StationName,\n    StationComplex,\n    Borough,\n    IsHistorical,\n    ServiceAvailable,\n    WifiAvailable\nFROM dbo.StageStation\n\nSELECT * FROM dbo.DimStation ORDER BY StationId;\n\n\n--create rides fact table\nIF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'FactRides')\nDROP TABLE FactRides\n\nCREATE TABLE dbo.FactRides (\n    RideDate DATE NOT NULL,\n    StationID INT NOT NULL,\n    DateUpdated DATETIME,\n    StationComplex NVARCHAR(100) NULL,\n    TransitMode NVARCHAR(100) NULL,\n    PaymentMethod NVARCHAR(100) NULL,\n    FareClassCategory NVARCHAR(100) NULL,\n    Transfers INT NULL\n)\nWITH\n(\n    DISTRIBUTION = HASH(StationComplex),\n    CLUSTERED COLUMNSTORE INDEX\n)\n\n\n--create rides staging table\n\nIF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'StageRides')\nDROP TABLE StageRides\n\nCREATE TABLE dbo.StageRides (\n    RideDate DATE NOT NULL,\n    StationComplex NVARCHAR(100) NULL,\n    TransitMode NVARCHAR(100) NULL,\n    PaymentMethod NVARCHAR(100) NULL,\n    FareClassCategory NVARCHAR(100) NULL,\n    Transfers INT NULL\n)\nWITH\n(\n    DISTRIBUTION = ROUND_ROBIN,\n    CLUSTERED COLUMNSTORE INDEX\n)\n\n\n\n--load data into staging table\n\nCOPY INTO dbo.StageRides\n(RideDate, StationComplex, TransitMode, PaymentMethod, FareClassCategory, Transfers)\nFROM 'https://mtapipelinestorage.dfs.core.windows.net/files/updated_data/rider_data/*parquet'\nWITH\n(\n    FILE_TYPE = 'PARQUET',\n    MAXERRORS = 0,\n    IDENTITY_INSERT = 'OFF'\n)\n\n--load data into Fact table\n\nINSERT INTO dbo.FactRides\nSELECT\n    r.RideDate,\n    s.StationId,\n    CURRENT_TIMESTAMP,\n    r.StationComplex,\n    r.TransitMode,\n    r.PaymentMethod,\n    r.FareClassCategory,\n    r.Transfers\nFROM StageRides r \nJOIN\nDimStation s ON s.StationComplex = r.StationComplex\n\nEND\nGO\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "mtasqlpool",
				"poolName": "mtasqlpool"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}